<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>StimulateOpenGL_II: StimPlugin.cpp Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
<link href="../../tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.4 -->
<div class="tabs">
  <ul>
    <li><a href="../../main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="../../annotated.html"><span>Classes</span></a></li>
    <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    <li><a href="../../dirs.html"><span>Directories</span></a></li>
  </ul>
</div>
<div class="nav">
<a class="el" href="../../dir_14c46e22c23b31d069aa66eceb578538.html">projects</a>&nbsp;&raquo&nbsp;<a class="el" href="../../dir_c7621532e76c5a52eb0dadf12b659c78.html">Leonardo</a>&nbsp;&raquo&nbsp;<a class="el" href="../../dir_1ef02126803d67bc0459919069fcb0d8.html">StimulateOpenGL</a>&nbsp;&raquo&nbsp;<a class="el" href="../../dir_19a3d25e4f3966778db7bf473054d0ec.html">StimulateOpenGL_II</a></div>
<h1>StimPlugin.cpp</h1><a href="../../d9/d03/StimPlugin_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include "<a class="code" href="../../d8/d9c/StimPlugin_8h.html">StimPlugin.h</a>"</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include "<a class="code" href="../../da/daa/StimApp_8h.html">StimApp.h</a>"</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include "<a class="code" href="../../d5/d3b/GLWindow_8h.html">GLWindow.h</a>"</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;QMessageBox&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;QDir&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;QGLContext&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="../../df/d10/StimGL__LeoDAQGL__Integration_8h.html">StimGL_LeoDAQGL_Integration.h</a>"</span>
<a name="l00008"></a>00008 
<a name="l00009"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#6fd2d8af162ddfa96330adecb9983fa0">00009</a> <a class="code" href="../../d0/d7e/classStimPlugin.html#6fd2d8af162ddfa96330adecb9983fa0">StimPlugin::StimPlugin</a>(<span class="keyword">const</span> QString &amp;name)
<a name="l00010"></a>00010     : QObject(<a class="code" href="../../d5/d08/classStimApp.html" title="The central class to the program that more-or-less encapsulates most objects and...">StimApp</a>::instance()-&gt;glWin()), parent(<a class="code" href="../../d5/d08/classStimApp.html" title="The central class to the program that more-or-less encapsulates most objects and...">StimApp</a>::instance()-&gt;glWin()), gasGen(1, <a class="code" href="../../d1/da2/classRNG.html" title="A class to generate random numbers.">RNG</a>::Gasdev), ran0Gen(1, <a class="code" href="../../d1/da2/classRNG.html" title="A class to generate random numbers.">RNG</a>::Ran0)
<a name="l00011"></a>00011 {
<a name="l00012"></a>00012     <a class="code" href="../../d0/d7e/classStimPlugin.html#2cbec86f764f0fa56acc1fa6e22193fc" title="iff true, we will notify LeoDAQGL of plugin start on unpause">needNotifyStart</a> = <span class="keyword">true</span>;
<a name="l00013"></a>00013     <a class="code" href="../../d0/d7e/classStimPlugin.html#40b27bc5ce101dc0eae98185c47df472" title="starts at 0 and gets incremented for each frame (each time drawFrame() is called)...">frameNum</a> = 0x7fffffff;
<a name="l00014"></a>00014     setObjectName(name);
<a name="l00015"></a>00015     <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;<a class="code" href="../../d8/da9/classGLWindow.html#e8ad8c52e2668dfb3b955f7b1212b51b" title="Plugins call this when they want to tell the execution engine that they have been...">pluginCreated</a>(<span class="keyword">this</span>);    
<a name="l00016"></a>00016 }
<a name="l00017"></a>00017 
<a name="l00018"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#527df4afa810e1493e7f1b62b85cd97a">00018</a> <a class="code" href="../../d0/d7e/classStimPlugin.html#527df4afa810e1493e7f1b62b85cd97a">StimPlugin::~StimPlugin</a>() 
<a name="l00019"></a>00019 {
<a name="l00020"></a>00020     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;<a class="code" href="../../d8/da9/classGLWindow.html#6d819d287cfd27919353753963edf2ec">runningPlugin</a>() == <span class="keyword">this</span>)  <a class="code" href="../../d0/d7e/classStimPlugin.html#958e569388fc4fb5be4be563a86d2a76" title="stop the plugin -- marks the plugin as &amp;#39;not running&amp;#39; with the GLWindow, calls...">stop</a>();
<a name="l00021"></a>00021     <a class="code" href="../../d5/d08/classStimApp.html#66bde746052947c120768d98e83b4a9c" title="Returns a pointer to the singleton instance of this class, if one exists, otherwise...">StimApp::instance</a>()-&gt;processEvents();
<a name="l00022"></a>00022     <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;<a class="code" href="../../d8/da9/classGLWindow.html#dda599ba8758ee94da3532e3006b20f4" title="Plugins call this method to inform the execution engine that they are being deleted...">pluginDeleted</a>(<span class="keyword">this</span>);   
<a name="l00023"></a>00023 }
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#eb19b900498e435bddeb9512a4458694">00025</a> <span class="keywordtype">bool</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#eb19b900498e435bddeb9512a4458694" title="Called as a result of start() when plugin is started.">StimPlugin::init</a>() { <span class="comment">/* default impl. does nothing */</span>  <span class="keywordflow">return</span> <span class="keyword">true</span>; }
<a name="l00026"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#68bdea5dc53d6e6b8e19267c4b458c08">00026</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#68bdea5dc53d6e6b8e19267c4b458c08" title="Called as a result of stop() when plugin is stopped.">StimPlugin::cleanup</a>() { <span class="comment">/* default impl. does nothing */</span> }
<a name="l00027"></a>00027 
<a name="l00028"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#3da5645469f8a41a5f9a13ceaee91143">00028</a> <span class="keywordtype">bool</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#3da5645469f8a41a5f9a13ceaee91143" title="Save pluign date to a file.">StimPlugin::saveData</a>(<span class="keywordtype">bool</span> use_gui)
<a name="l00029"></a>00029 {
<a name="l00030"></a>00030     <span class="keywordflow">if</span> (!openOutputFile(use_gui)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00031"></a>00031     <a class="code" href="../../d0/d7e/classStimPlugin.html#695d55237260c81ab30cb4f12a2e5464" title="default implementation does nothing, reimplement -- called for you on plugin exit...">save</a>(); <span class="comment">// plugin-specific save</span>
<a name="l00032"></a>00032     writeGeneralInfo();
<a name="l00033"></a>00033     <a class="code" href="../../db/d39/classUtil_1_1Log.html" title="Super class of Debug, Warning, Error classes.">Log</a>() &lt;&lt; <span class="stringliteral">"Saved data for "</span> &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#c855a6f3fd359456f0db60ca01c72517" title="just calls QObject::objectName()">name</a>() &lt;&lt; <span class="stringliteral">" to `"</span> &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#3ae19d1a26dea8bdc1e5ec8337365541" title="Write to this file when saving data.">outFile</a>.fileName() &lt;&lt; <span class="stringliteral">"'"</span>;
<a name="l00034"></a>00034     closeOutputFile();    
<a name="l00035"></a>00035     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00036"></a>00036 }
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#958e569388fc4fb5be4be563a86d2a76">00038</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#958e569388fc4fb5be4be563a86d2a76" title="stop the plugin -- marks the plugin as &amp;#39;not running&amp;#39; with the GLWindow, calls...">StimPlugin::stop</a>(<span class="keywordtype">bool</span> doSave, <span class="keywordtype">bool</span> useGui)
<a name="l00039"></a>00039 {
<a name="l00040"></a>00040     <a class="code" href="../../d0/d7e/classStimPlugin.html#a629d28d6b1a278cc1eee7e712ed40f7">endtime</a> = QDateTime::currentDateTime();
<a name="l00041"></a>00041     <span class="keywordflow">if</span> (doSave) {
<a name="l00042"></a>00042         <a class="code" href="../../d0/d7e/classStimPlugin.html#3da5645469f8a41a5f9a13ceaee91143" title="Save pluign date to a file.">saveData</a>(useGui);
<a name="l00043"></a>00043     }
<a name="l00044"></a>00044 
<a name="l00045"></a>00045     <span class="comment">// Notify LeoDAQGL via a socket.. if possible..</span>
<a name="l00046"></a>00046     <span class="comment">// Notify LeoDAQGL via a socket.. if possible..</span>
<a name="l00047"></a>00047     <span class="keywordflow">if</span> (<a class="code" href="../../d2/daf/namespaceUtil.html#c0a2da61553e34ad735a51325f29ae37" title="Returns a pointer to the StimApp singleton instance.">stimApp</a>()-&gt;leoDAQGLNotifyParams.enabled) {
<a name="l00048"></a>00048         <a class="code" href="../../d0/d7e/classStimPlugin.html#d1af564d84dd406844fdb960f4401d81">notifySpikeGLAboutStop</a>();
<a name="l00049"></a>00049     }
<a name="l00050"></a>00050     
<a name="l00051"></a>00051     <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;<a class="code" href="../../d8/da9/classGLWindow.html#bfbd86a2a103b4e31607ab600e60c5fd" title="Plugins call this method when they want to tell the execution engine that they have...">pluginStopped</a>(<span class="keyword">this</span>);
<a name="l00052"></a>00052     emit <a class="code" href="../../d0/d7e/classStimPlugin.html#9df353151d3a91d6d1f0de9b2e22018c" title="emitted whenever plugin stops">stopped</a>();
<a name="l00053"></a>00053     <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;makeCurrent();
<a name="l00054"></a>00054     glClearColor(0.5, 0.5,  0.5, 1.);
<a name="l00055"></a>00055     glColor4f(0.5, 0.5,  0.5, 1.);
<a name="l00056"></a>00056     glClear( GL_COLOR_BUFFER_BIT );    
<a name="l00057"></a>00057     <a class="code" href="../../d0/d7e/classStimPlugin.html#68bdea5dc53d6e6b8e19267c4b458c08" title="Called as a result of stop() when plugin is stopped.">cleanup</a>();
<a name="l00058"></a>00058     <span class="comment">// restore original matrices from matrix stack</span>
<a name="l00059"></a>00059     glMatrixMode(GL_MODELVIEW);
<a name="l00060"></a>00060     glLoadIdentity();
<a name="l00061"></a>00061     <a class="code" href="../../d0/d7e/classStimPlugin.html#40b27bc5ce101dc0eae98185c47df472" title="starts at 0 and gets incremented for each frame (each time drawFrame() is called)...">frameNum</a> = 0;
<a name="l00062"></a>00062 }
<a name="l00063"></a>00063 
<a name="l00064"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#0e257811d1c4ec2d1a86ff90859a2e77">00064</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#0e257811d1c4ec2d1a86ff90859a2e77" title="start the plugin -- marks the plugin as &amp;#39;running&amp;#39; with the GLWindow and calls...">StimPlugin::start</a>(<span class="keywordtype">bool</span> startUnpaused)
<a name="l00065"></a>00065 {
<a name="l00066"></a>00066     <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;<a class="code" href="../../d8/da9/classGLWindow.html#688ea41730716f4d571c6e8684d39f2e" title="Plugins call this method when they want to tell the execution engine that they have...">pluginStarted</a>(<span class="keyword">this</span>);
<a name="l00067"></a>00067 
<a name="l00068"></a>00068     <span class="comment">// Notify LeoDAQGL via a socket.. if possible..</span>
<a name="l00069"></a>00069     <a class="code" href="../../d0/d7e/classStimPlugin.html#2cbec86f764f0fa56acc1fa6e22193fc" title="iff true, we will notify LeoDAQGL of plugin start on unpause">needNotifyStart</a> = <span class="keyword">false</span>;
<a name="l00070"></a>00070     <span class="keywordflow">if</span> (<a class="code" href="../../d2/daf/namespaceUtil.html#c0a2da61553e34ad735a51325f29ae37" title="Returns a pointer to the StimApp singleton instance.">stimApp</a>()-&gt;leoDAQGLNotifyParams.enabled) {
<a name="l00071"></a>00071         <span class="keywordflow">if</span> (startUnpaused) {
<a name="l00072"></a>00072             <a class="code" href="../../d0/d7e/classStimPlugin.html#0b1c4ecfa862531f98a5fd3d78e80920">notifySpikeGLAboutStart</a>();
<a name="l00073"></a>00073         } <span class="keywordflow">else</span> {
<a name="l00074"></a>00074             <a class="code" href="../../d0/d7e/classStimPlugin.html#2cbec86f764f0fa56acc1fa6e22193fc" title="iff true, we will notify LeoDAQGL of plugin start on unpause">needNotifyStart</a> = <span class="keyword">true</span>;
<a name="l00075"></a>00075         }
<a name="l00076"></a>00076     }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078     emit <a class="code" href="../../d0/d7e/classStimPlugin.html#8a2d2e8fcce67025fbaadba61bd53733" title="emitted when plugin starts">started</a>();
<a name="l00079"></a>00079     
<a name="l00080"></a>00080     <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;makeCurrent();
<a name="l00081"></a>00081 
<a name="l00082"></a>00082     <span class="comment">// start out with identity matrix</span>
<a name="l00083"></a>00083     glMatrixMode(GL_MODELVIEW);
<a name="l00084"></a>00084     glLoadIdentity();
<a name="l00085"></a>00085     <a class="code" href="../../d0/d7e/classStimPlugin.html#40b27bc5ce101dc0eae98185c47df472" title="starts at 0 and gets incremented for each frame (each time drawFrame() is called)...">frameNum</a> = 0;
<a name="l00086"></a>00086     <a class="code" href="../../d0/d7e/classStimPlugin.html#50978970652f9e39bffed18e814931db">fps</a> = <a class="code" href="../../d0/d7e/classStimPlugin.html#bb5dc96578e9a287638ba69e31804251">fpsAvg</a> = 0;
<a name="l00087"></a>00087     <a class="code" href="../../d0/d7e/classStimPlugin.html#60405fc488892954a38c022397b9d1d2">fpsMin</a> = 9e9;
<a name="l00088"></a>00088     <a class="code" href="../../d0/d7e/classStimPlugin.html#4bc7de35e4ef07c7f68cbbdaf9b353bc">fpsMax</a> = 0;
<a name="l00089"></a>00089     <a class="code" href="../../d0/d7e/classStimPlugin.html#0d9a9cea3df7446b1bc52780c3c3f914">begintime</a> = QDateTime::currentDateTime();
<a name="l00090"></a>00090     <a class="code" href="../../d0/d7e/classStimPlugin.html#a629d28d6b1a278cc1eee7e712ed40f7">endtime</a> = QDateTime(); <span class="comment">// set to null datetime</span>
<a name="l00091"></a>00091     <a class="code" href="../../d0/d7e/classStimPlugin.html#359bbb3711627f369a61d5def8bfc119">missedFrames</a>.clear();
<a name="l00092"></a>00092     <a class="code" href="../../d0/d7e/classStimPlugin.html#3be7ce6111ce969d88ebadd75343601e" title="a list of cycle times for skipped/missed frames, in msecs">missedFrameTimes</a>.clear();
<a name="l00093"></a>00093     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7e/classStimPlugin.html#359bbb3711627f369a61d5def8bfc119">missedFrames</a>.capacity()) <a class="code" href="../../d0/d7e/classStimPlugin.html#359bbb3711627f369a61d5def8bfc119">missedFrames</a>.reserve(4096);
<a name="l00094"></a>00094     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7e/classStimPlugin.html#3be7ce6111ce969d88ebadd75343601e" title="a list of cycle times for skipped/missed frames, in msecs">missedFrameTimes</a>.capacity()) <a class="code" href="../../d0/d7e/classStimPlugin.html#3be7ce6111ce969d88ebadd75343601e" title="a list of cycle times for skipped/missed frames, in msecs">missedFrameTimes</a>.reserve(4096);
<a name="l00095"></a>00095     <a class="code" href="../../d0/d7e/classStimPlugin.html#bb9032e65d1aed63ebb47d8f0f1ae6f4" title="Write to this variable to optionally inform the application that you want a custom...">customStatusBarString</a> = <span class="stringliteral">""</span>;
<a name="l00096"></a>00096     <span class="keywordflow">if</span> ( !startUnpaused ) <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;<a class="code" href="../../d8/da9/classGLWindow.html#31adf747b270050d37b28ec736389bb1" title="Toggles the paused/unpaused state of the plugin execution engine.">pauseUnpause</a>();
<a name="l00097"></a>00097     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7e/classStimPlugin.html#eb19b900498e435bddeb9512a4458694" title="Called as a result of start() when plugin is started.">init</a>()) { 
<a name="l00098"></a>00098         <a class="code" href="../../d0/d7e/classStimPlugin.html#958e569388fc4fb5be4be563a86d2a76" title="stop the plugin -- marks the plugin as &amp;#39;not running&amp;#39; with the GLWindow, calls...">stop</a>(); 
<a name="l00099"></a>00099         <a class="code" href="../../d9/d92/classUtil_1_1Error.html" title="Stream-like class to print an error message to the app&amp;#39;s console window Example:...">Error</a>() &lt;&lt; <span class="stringliteral">"Plugin "</span> &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#c855a6f3fd359456f0db60ca01c72517" title="just calls QObject::objectName()">name</a>() &lt;&lt; <span class="stringliteral">" failed to initialize."</span>; 
<a name="l00100"></a>00100         <span class="keywordflow">return</span>; 
<a name="l00101"></a>00101     }
<a name="l00102"></a>00102 }
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#ef0c73bf831f0a78eee110ece2df2ac1">00104</a> <span class="keywordtype">unsigned</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#ef0c73bf831f0a78eee110ece2df2ac1" title="returns width in pixels of the opengl 2d area">StimPlugin::width</a>()<span class="keyword"> const</span>
<a name="l00105"></a>00105 <span class="keyword"></span>{
<a name="l00106"></a>00106     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;width();
<a name="l00107"></a>00107 }
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#6b0b70bbeca546d2d2684975fd81d018">00109</a> <span class="keywordtype">unsigned</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#6b0b70bbeca546d2d2684975fd81d018" title="returns height in pixels of the opengl 2d area">StimPlugin::height</a>()<span class="keyword"> const</span>
<a name="l00110"></a>00110 <span class="keyword"></span>{
<a name="l00111"></a>00111     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;height();
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="keywordtype">void</span> StimPlugin::computeFPS()
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116     <span class="keywordtype">double</span> tDiff = (<a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;<a class="code" href="../../d8/da9/classGLWindow.html#f1a7f92c1f069f28208a0556f33478bd">tThisFrame</a> - <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;<a class="code" href="../../d8/da9/classGLWindow.html#11d5edfe7959fc93f65a9d7e0ed9037a">tLastLastFrame</a>)/2.; 
<a name="l00117"></a>00117     <span class="keywordflow">if</span> (tDiff &gt; 0.0 &amp;&amp; <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;<a class="code" href="../../d8/da9/classGLWindow.html#11d5edfe7959fc93f65a9d7e0ed9037a">tLastLastFrame</a> &gt; 0.) {
<a name="l00118"></a>00118         <a class="code" href="../../d0/d7e/classStimPlugin.html#50978970652f9e39bffed18e814931db">fps</a> = 1.0/tDiff;
<a name="l00119"></a>00119     } <span class="keywordflow">else</span>
<a name="l00120"></a>00120         <a class="code" href="../../d0/d7e/classStimPlugin.html#50978970652f9e39bffed18e814931db">fps</a> = 0.;
<a name="l00121"></a>00121     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> minFrameNum = 20;
<a name="l00122"></a>00122     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> nFramesAvg = 60;
<a name="l00123"></a>00123     <span class="keywordtype">double</span> nAvg = double(<a class="code" href="../../d1/dc8/Util_8h.html#3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(nFramesAvg, (<a class="code" href="../../d0/d7e/classStimPlugin.html#40b27bc5ce101dc0eae98185c47df472" title="starts at 0 and gets incremented for each frame (each time drawFrame() is called)...">frameNum</a>-minFrameNum)));
<a name="l00124"></a>00124     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7e/classStimPlugin.html#40b27bc5ce101dc0eae98185c47df472" title="starts at 0 and gets incremented for each frame (each time drawFrame() is called)...">frameNum</a> &gt;= minFrameNum) {
<a name="l00125"></a>00125         <a class="code" href="../../d0/d7e/classStimPlugin.html#bb5dc96578e9a287638ba69e31804251">fpsAvg</a> = <a class="code" href="../../d0/d7e/classStimPlugin.html#bb5dc96578e9a287638ba69e31804251">fpsAvg</a> * nAvg + <a class="code" href="../../d0/d7e/classStimPlugin.html#50978970652f9e39bffed18e814931db">fps</a>;
<a name="l00126"></a>00126         <a class="code" href="../../d0/d7e/classStimPlugin.html#bb5dc96578e9a287638ba69e31804251">fpsAvg</a> /= nAvg+1.;
<a name="l00127"></a>00127         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7e/classStimPlugin.html#4bc7de35e4ef07c7f68cbbdaf9b353bc">fpsMax</a> &lt; fps) <a class="code" href="../../d0/d7e/classStimPlugin.html#4bc7de35e4ef07c7f68cbbdaf9b353bc">fpsMax</a> = fps;
<a name="l00128"></a>00128         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7e/classStimPlugin.html#60405fc488892954a38c022397b9d1d2">fpsMin</a> &gt; fps) <a class="code" href="../../d0/d7e/classStimPlugin.html#60405fc488892954a38c022397b9d1d2">fpsMin</a> = fps;
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00132"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#5eba98527ca0ca0329cd71677f821d33">00132</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#5eba98527ca0ca0329cd71677f821d33" title="Called immediately after a vsync (if not paused).">StimPlugin::afterVSync</a>(<span class="keywordtype">bool</span> b) { (void)b; <span class="comment">/* nothing.. */</span> }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 <span class="keywordtype">bool</span> StimPlugin::openOutputFile(<span class="keywordtype">bool</span> use_gui)
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136     closeOutputFile();
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     QString date = QDateTime(QDateTime::currentDateTime()).toString(<span class="stringliteral">"yyyyMMdd"</span>);
<a name="l00139"></a>00139     QDir dir;
<a name="l00140"></a>00140     <span class="comment">// make sure output directory is valid, if not keep asking the used</span>
<a name="l00141"></a>00141     <span class="comment">// for a dir since this save operation is supposed to always succeed</span>
<a name="l00142"></a>00142     forever {
<a name="l00143"></a>00143         dir.setPath(<a class="code" href="../../d2/daf/namespaceUtil.html#c0a2da61553e34ad735a51325f29ae37" title="Returns a pointer to the StimApp singleton instance.">stimApp</a>()-&gt;outputDirectory() + <span class="stringliteral">"/"</span> + date);
<a name="l00144"></a>00144         <span class="keywordflow">if</span> (!dir.exists() &amp;&amp; !dir.mkpath(dir.path())) {
<a name="l00145"></a>00145             <span class="keywordflow">if</span> (use_gui) {
<a name="l00146"></a>00146                 QMessageBox::critical(0, <span class="stringliteral">"Output directory doesn't exist"</span>,
<a name="l00147"></a>00147                                       <span class="stringliteral">"Output directory doesn't exist!\nSpecify a valid directory"</span>);
<a name="l00148"></a>00148                 <a class="code" href="../../d2/daf/namespaceUtil.html#c0a2da61553e34ad735a51325f29ae37" title="Returns a pointer to the StimApp singleton instance.">stimApp</a>()-&gt;<a class="code" href="../../d5/d08/classStimApp.html#0b13749e680424bcc7093c84eeca302e" title="Prompts the user to pick a save directory.">pickOutputDir</a>();
<a name="l00149"></a>00149                 <span class="keywordflow">continue</span>;
<a name="l00150"></a>00150             } <span class="keywordflow">else</span> <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00151"></a>00151         }
<a name="l00152"></a>00152         <span class="keywordflow">break</span>;
<a name="l00153"></a>00153     }
<a name="l00154"></a>00154    
<a name="l00155"></a>00155     <span class="comment">// try to find an unused filename by incrementing the index .. </span>
<a name="l00156"></a>00156     <a class="code" href="../../d0/d7e/classStimPlugin.html#3ae19d1a26dea8bdc1e5ec8337365541" title="Write to this file when saving data.">outFile</a>.setFileName(<span class="stringliteral">""</span>);
<a name="l00157"></a>00157     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; !<a class="code" href="../../d0/d7e/classStimPlugin.html#3ae19d1a26dea8bdc1e5ec8337365541" title="Write to this file when saving data.">outFile</a>.fileName().length() || <a class="code" href="../../d0/d7e/classStimPlugin.html#3ae19d1a26dea8bdc1e5ec8337365541" title="Write to this file when saving data.">outFile</a>.exists(); ++i) {        
<a name="l00158"></a>00158         QString fname = dir.path() + <span class="stringliteral">"/"</span> + <a class="code" href="../../d0/d7e/classStimPlugin.html#c855a6f3fd359456f0db60ca01c72517" title="just calls QObject::objectName()">name</a>() + <span class="stringliteral">"_"</span> + QString::number(i) + <span class="stringliteral">".log"</span>;
<a name="l00159"></a>00159         <a class="code" href="../../d0/d7e/classStimPlugin.html#3ae19d1a26dea8bdc1e5ec8337365541" title="Write to this file when saving data.">outFile</a>.setFileName(fname);
<a name="l00160"></a>00160     }   
<a name="l00161"></a>00161     <span class="comment">// finally open the file</span>
<a name="l00162"></a>00162     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7e/classStimPlugin.html#3ae19d1a26dea8bdc1e5ec8337365541" title="Write to this file when saving data.">outFile</a>.open(QIODevice::WriteOnly|QIODevice::Truncate)) {
<a name="l00163"></a>00163         <span class="keywordflow">if</span> (use_gui)
<a name="l00164"></a>00164             QMessageBox::critical(0, <span class="stringliteral">"Error opening file"</span>,
<a name="l00165"></a>00165                                   QString(<span class="stringliteral">"Cannot open `"</span>) + <a class="code" href="../../d0/d7e/classStimPlugin.html#3ae19d1a26dea8bdc1e5ec8337365541" title="Write to this file when saving data.">outFile</a>.fileName() + <span class="stringliteral">"' for writing.\nStim. log data will not be saved!\n"</span>);
<a name="l00166"></a>00166         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168     <a class="code" href="../../d0/d7e/classStimPlugin.html#f31bddf8c47e3fb85e222764bac089b9" title="the output stream you should use in your &amp;quot;save()&amp;quot; method reimplementation...">outStream</a>.setDevice(&amp;<a class="code" href="../../d0/d7e/classStimPlugin.html#3ae19d1a26dea8bdc1e5ec8337365541" title="Write to this file when saving data.">outFile</a>);
<a name="l00169"></a>00169     <a class="code" href="../../d0/d7e/classStimPlugin.html#f31bddf8c47e3fb85e222764bac089b9" title="the output stream you should use in your &amp;quot;save()&amp;quot; method reimplementation...">outStream</a>.reset();
<a name="l00170"></a>00170     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 <span class="keywordtype">void</span> StimPlugin::writeGeneralInfo()
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175     <a class="code" href="../../d0/d7e/classStimPlugin.html#f31bddf8c47e3fb85e222764bac089b9" title="the output stream you should use in your &amp;quot;save()&amp;quot; method reimplementation...">outStream</a> &lt;&lt; <span class="stringliteral">"Stimulus: "</span> &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#c855a6f3fd359456f0db60ca01c72517" title="just calls QObject::objectName()">name</a>() &lt;&lt; <span class="stringliteral">" run by "</span> &lt;&lt; <a class="code" href="../../de/d3a/Version_8h.html#cfc1668731750cb1ee8974b8a7c133ef">VERSION_STR</a> &lt;&lt; <span class="stringliteral">"\n"</span>
<a name="l00176"></a>00176               &lt;&lt; <span class="stringliteral">"Run on host: "</span> &lt;&lt; <a class="code" href="../../d2/daf/namespaceUtil.html#93f1032aee31dac9391682b312a314b5" title="returns the current host name">getHostName</a>() &lt;&lt; <span class="stringliteral">"\n"</span>
<a name="l00177"></a>00177               &lt;&lt; <span class="stringliteral">"Start: "</span> &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#0d9a9cea3df7446b1bc52780c3c3f914">begintime</a>.toString() &lt;&lt; <span class="stringliteral">"\n"</span>
<a name="l00178"></a>00178               &lt;&lt; <span class="stringliteral">"End: "</span> &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#a629d28d6b1a278cc1eee7e712ed40f7">endtime</a>.toString() &lt;&lt; <span class="stringliteral">"\n"</span> 
<a name="l00179"></a>00179               &lt;&lt; <span class="stringliteral">"Total number of frames: "</span> &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#40b27bc5ce101dc0eae98185c47df472" title="starts at 0 and gets incremented for each frame (each time drawFrame() is called)...">frameNum</a> &lt;&lt; <span class="stringliteral">"\n"</span> 
<a name="l00180"></a>00180               &lt;&lt; <span class="stringliteral">"FPS Average: "</span> &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#bb5dc96578e9a287638ba69e31804251">fpsAvg</a> &lt;&lt; <span class="stringliteral">"\n"</span>;
<a name="l00181"></a>00181     <a class="code" href="../../d0/d7e/classStimPlugin.html#f31bddf8c47e3fb85e222764bac089b9" title="the output stream you should use in your &amp;quot;save()&amp;quot; method reimplementation...">outStream</a> &lt;&lt; <span class="stringliteral">"Number of doubled/skipped frames: "</span> &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#359bbb3711627f369a61d5def8bfc119">missedFrames</a>.size() &lt;&lt; <span class="stringliteral">"\n"</span>;
<a name="l00182"></a>00182     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#359bbb3711627f369a61d5def8bfc119">missedFrames</a>.size() &amp;&amp; i &lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#3be7ce6111ce969d88ebadd75343601e" title="a list of cycle times for skipped/missed frames, in msecs">missedFrameTimes</a>.size(); ++i )
<a name="l00183"></a>00183         <a class="code" href="../../d0/d7e/classStimPlugin.html#f31bddf8c47e3fb85e222764bac089b9" title="the output stream you should use in your &amp;quot;save()&amp;quot; method reimplementation...">outStream</a> &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#359bbb3711627f369a61d5def8bfc119">missedFrames</a>[i] &lt;&lt; <span class="stringliteral">"  "</span> &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#3be7ce6111ce969d88ebadd75343601e" title="a list of cycle times for skipped/missed frames, in msecs">missedFrameTimes</a>[i] &lt;&lt; <span class="stringliteral">"\n"</span>;    
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#952fea9770560d6fd913e0acce85cdca">00186</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#952fea9770560d6fd913e0acce85cdca" title="called by GLWindow when a frameskip is detected..">StimPlugin::putMissedFrame</a>(<span class="keywordtype">unsigned</span> cycleTimeMsecs)
<a name="l00187"></a>00187 {
<a name="l00188"></a>00188     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7e/classStimPlugin.html#359bbb3711627f369a61d5def8bfc119">missedFrames</a>.capacity() == <a class="code" href="../../d0/d7e/classStimPlugin.html#359bbb3711627f369a61d5def8bfc119">missedFrames</a>.size())
<a name="l00189"></a>00189         <a class="code" href="../../d0/d7e/classStimPlugin.html#359bbb3711627f369a61d5def8bfc119">missedFrames</a>.reserve(<a class="code" href="../../d0/d7e/classStimPlugin.html#359bbb3711627f369a61d5def8bfc119">missedFrames</a>.size()*2); <span class="comment">// make it 2x bigger</span>
<a name="l00190"></a>00190     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7e/classStimPlugin.html#3be7ce6111ce969d88ebadd75343601e" title="a list of cycle times for skipped/missed frames, in msecs">missedFrameTimes</a>.capacity() == <a class="code" href="../../d0/d7e/classStimPlugin.html#3be7ce6111ce969d88ebadd75343601e" title="a list of cycle times for skipped/missed frames, in msecs">missedFrameTimes</a>.size())
<a name="l00191"></a>00191         <a class="code" href="../../d0/d7e/classStimPlugin.html#3be7ce6111ce969d88ebadd75343601e" title="a list of cycle times for skipped/missed frames, in msecs">missedFrameTimes</a>.reserve(<a class="code" href="../../d0/d7e/classStimPlugin.html#3be7ce6111ce969d88ebadd75343601e" title="a list of cycle times for skipped/missed frames, in msecs">missedFrameTimes</a>.size()*2); <span class="comment">// make it 2x bigger</span>
<a name="l00192"></a>00192     <a class="code" href="../../d0/d7e/classStimPlugin.html#359bbb3711627f369a61d5def8bfc119">missedFrames</a>.push_back(<a class="code" href="../../d0/d7e/classStimPlugin.html#40b27bc5ce101dc0eae98185c47df472" title="starts at 0 and gets incremented for each frame (each time drawFrame() is called)...">frameNum</a>);
<a name="l00193"></a>00193     <a class="code" href="../../d0/d7e/classStimPlugin.html#3be7ce6111ce969d88ebadd75343601e" title="a list of cycle times for skipped/missed frames, in msecs">missedFrameTimes</a>.push_back(cycleTimeMsecs);
<a name="l00194"></a>00194 }
<a name="l00195"></a>00195 
<a name="l00196"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#429e8aeb7f9e14eeb90118177192a4d8">00196</a> QByteArray <a class="code" href="../../d0/d7e/classStimPlugin.html#429e8aeb7f9e14eeb90118177192a4d8" title="Grab arbitrary frame data by number from a plugin.">StimPlugin::getFrameDump</a>(<span class="keywordtype">unsigned</span> num, GLenum datatype)
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> datasize = <a class="code" href="../../d0/d7e/classStimPlugin.html#ef0c73bf831f0a78eee110ece2df2ac1" title="returns width in pixels of the opengl 2d area">width</a>()*<a class="code" href="../../d0/d7e/classStimPlugin.html#6b0b70bbeca546d2d2684975fd81d018" title="returns height in pixels of the opengl 2d area">height</a>()*3; <span class="comment">// R, G, B broken out per pix.</span>
<a name="l00199"></a>00199     <span class="keywordflow">switch</span> (datatype) {
<a name="l00200"></a>00200     <span class="keywordflow">case</span> GL_BYTE:
<a name="l00201"></a>00201     <span class="keywordflow">case</span> GL_UNSIGNED_BYTE: 
<a name="l00202"></a>00202         datasize *= <span class="keyword">sizeof</span>(GLubyte); <span class="keywordflow">break</span>;
<a name="l00203"></a>00203     <span class="keywordflow">case</span> GL_FLOAT:
<a name="l00204"></a>00204         datasize *= <span class="keyword">sizeof</span>(GLfloat); <span class="keywordflow">break</span>;
<a name="l00205"></a>00205     <span class="keywordflow">case</span> GL_SHORT:
<a name="l00206"></a>00206     <span class="keywordflow">case</span> GL_UNSIGNED_SHORT:
<a name="l00207"></a>00207         datasize *= <span class="keyword">sizeof</span>(GLshort); <span class="keywordflow">break</span>;
<a name="l00208"></a>00208     <span class="keywordflow">case</span> GL_INT:
<a name="l00209"></a>00209     <span class="keywordflow">case</span> GL_UNSIGNED_INT:
<a name="l00210"></a>00210         datasize *= <span class="keyword">sizeof</span>(GLuint); <span class="keywordflow">break</span>;
<a name="l00211"></a>00211     <span class="keywordflow">default</span>:
<a name="l00212"></a>00212         <a class="code" href="../../d9/d92/classUtil_1_1Error.html" title="Stream-like class to print an error message to the app&amp;#39;s console window Example:...">Error</a>() &lt;&lt; <span class="stringliteral">"Unsupported datatype `"</span> &lt;&lt; datatype &lt;&lt; <span class="stringliteral">"' in StimPlugin::getFrameNum!"</span>;
<a name="l00213"></a>00213         <span class="keywordflow">return</span> QByteArray();
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215     QByteArray ret(datasize, 0);
<a name="l00216"></a>00216     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;<a class="code" href="../../d8/da9/classGLWindow.html#6d819d287cfd27919353753963edf2ec">runningPlugin</a>() != <span class="keyword">this</span>) {
<a name="l00217"></a>00217         <a class="code" href="../../d7/da1/classUtil_1_1Warning.html" title="Stream-like class to print a warning message to the app&amp;#39;s console window.">Warning</a>() &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#c855a6f3fd359456f0db60ca01c72517" title="just calls QObject::objectName()">name</a>() &lt;&lt; <span class="stringliteral">" wasn't the currently-running plugin, stopping current and restarting with `"</span> &lt;&lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#c855a6f3fd359456f0db60ca01c72517" title="just calls QObject::objectName()">name</a>() &lt;&lt; <span class="stringliteral">"'"</span>;        
<a name="l00218"></a>00218         <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;<a class="code" href="../../d8/da9/classGLWindow.html#6d819d287cfd27919353753963edf2ec">runningPlugin</a>()-&gt;<a class="code" href="../../d0/d7e/classStimPlugin.html#958e569388fc4fb5be4be563a86d2a76" title="stop the plugin -- marks the plugin as &amp;#39;not running&amp;#39; with the GLWindow, calls...">stop</a>();
<a name="l00219"></a>00219         <a class="code" href="../../d0/d7e/classStimPlugin.html#0e257811d1c4ec2d1a86ff90859a2e77" title="start the plugin -- marks the plugin as &amp;#39;running&amp;#39; with the GLWindow and calls...">start</a>(<span class="keyword">false</span>);
<a name="l00220"></a>00220     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (num &lt; <a class="code" href="../../d0/d7e/classStimPlugin.html#40b27bc5ce101dc0eae98185c47df472" title="starts at 0 and gets incremented for each frame (each time drawFrame() is called)...">frameNum</a>) {
<a name="l00221"></a>00221         <a class="code" href="../../d7/da1/classUtil_1_1Warning.html" title="Stream-like class to print a warning message to the app&amp;#39;s console window.">Warning</a>() &lt;&lt; <span class="stringliteral">"Got non-increasing read of frame # "</span> &lt;&lt; num &lt;&lt; <span class="stringliteral">", restarting plugin and fast-forwarding to frame # "</span> &lt;&lt; num &lt;&lt; <span class="stringliteral">" (this is slower than a sequential read)."</span>;
<a name="l00222"></a>00222         <a class="code" href="../../d0/d7e/classStimPlugin.html#958e569388fc4fb5be4be563a86d2a76" title="stop the plugin -- marks the plugin as &amp;#39;not running&amp;#39; with the GLWindow, calls...">stop</a>();
<a name="l00223"></a>00223         <a class="code" href="../../d0/d7e/classStimPlugin.html#0e257811d1c4ec2d1a86ff90859a2e77" title="start the plugin -- marks the plugin as &amp;#39;running&amp;#39; with the GLWindow and calls...">start</a>(<span class="keyword">false</span>);
<a name="l00224"></a>00224     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;<a class="code" href="../../d8/da9/classGLWindow.html#0ac348cf8a566d7a2114d1f39dd92779" title="Returns true if plugin execution is in the paused state, false otherwise.">isPaused</a>()) {
<a name="l00225"></a>00225         <a class="code" href="../../d7/da1/classUtil_1_1Warning.html" title="Stream-like class to print a warning message to the app&amp;#39;s console window.">Warning</a>() &lt;&lt; <span class="stringliteral">"StimPlugin::getFrameNum() called with a non-paused parent!  This is not really supported!  FIXME!"</span>;
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227     
<a name="l00228"></a>00228     <span class="keywordflow">if</span> (QGLContext::currentContext() != <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;context())
<a name="l00229"></a>00229         <a class="code" href="../../d0/d7e/classStimPlugin.html#ac019e751e39f9313da1266ac916b149">parent</a>-&gt;makeCurrent();
<a name="l00230"></a>00230     <span class="keywordtype">double</span> tFrame = 1./<a class="code" href="../../d2/daf/namespaceUtil.html#d07cd2b2e9bdbe6545862c70a19961d9" title="retrieve the refresh rate from HW (implemented in osdep.cpp)">getHWRefreshRate</a>();
<a name="l00231"></a>00231     <span class="keywordflow">do</span>  {
<a name="l00232"></a>00232         <span class="keywordtype">double</span> t0 = <a class="code" href="../../d2/daf/namespaceUtil.html#04f06fcc6c10988cd6f85141be2bd5cc" title="retrieve a time value from the system&amp;#39;s high resolution timer">getTime</a>();
<a name="l00233"></a>00233         <a class="code" href="../../d0/d7e/classStimPlugin.html#3bf0ec85f644e77716bd0514a9d22b37" title="the number of seconds left in this cycle -- updated by glWindow before calling afterVSync...">cycleTimeLeft</a> = tFrame;
<a name="l00234"></a>00234         <a class="code" href="../../d0/d7e/classStimPlugin.html#214a0b65be9baaef474d3ac03e74884a" title="The meat of every plugin -- re-implement this function to draw the actual frame....">drawFrame</a>();
<a name="l00235"></a>00235         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7e/classStimPlugin.html#40b27bc5ce101dc0eae98185c47df472" title="starts at 0 and gets incremented for each frame (each time drawFrame() is called)...">frameNum</a> == num) {
<a name="l00236"></a>00236             GLint bufwas;
<a name="l00237"></a>00237             glGetIntegerv(GL_READ_BUFFER, &amp;bufwas);
<a name="l00238"></a>00238             glReadBuffer(GL_BACK);
<a name="l00239"></a>00239             glReadPixels(0, 0, <a class="code" href="../../d0/d7e/classStimPlugin.html#ef0c73bf831f0a78eee110ece2df2ac1" title="returns width in pixels of the opengl 2d area">width</a>(), <a class="code" href="../../d0/d7e/classStimPlugin.html#6b0b70bbeca546d2d2684975fd81d018" title="returns height in pixels of the opengl 2d area">height</a>(), GL_RGB, datatype, ret.data());
<a name="l00240"></a>00240             glReadBuffer(bufwas);
<a name="l00241"></a>00241         }
<a name="l00242"></a>00242         ++<a class="code" href="../../d0/d7e/classStimPlugin.html#40b27bc5ce101dc0eae98185c47df472" title="starts at 0 and gets incremented for each frame (each time drawFrame() is called)...">frameNum</a>;
<a name="l00243"></a>00243         <a class="code" href="../../d0/d7e/classStimPlugin.html#3bf0ec85f644e77716bd0514a9d22b37" title="the number of seconds left in this cycle -- updated by glWindow before calling afterVSync...">cycleTimeLeft</a> -= <a class="code" href="../../d2/daf/namespaceUtil.html#04f06fcc6c10988cd6f85141be2bd5cc" title="retrieve a time value from the system&amp;#39;s high resolution timer">getTime</a>()-t0;
<a name="l00244"></a>00244         <a class="code" href="../../d0/d7e/classStimPlugin.html#5eba98527ca0ca0329cd71677f821d33" title="Called immediately after a vsync (if not paused).">afterVSync</a>(<span class="keyword">true</span>);
<a name="l00245"></a>00245     } <span class="keywordflow">while</span> (<a class="code" href="../../d0/d7e/classStimPlugin.html#40b27bc5ce101dc0eae98185c47df472" title="starts at 0 and gets incremented for each frame (each time drawFrame() is called)...">frameNum</a> &lt;= num);
<a name="l00246"></a>00246     glClear(GL_COLOR_BUFFER_BIT);
<a name="l00247"></a>00247     <span class="keywordflow">return</span> ret;
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00250"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#0b1c4ecfa862531f98a5fd3d78e80920">00250</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#0b1c4ecfa862531f98a5fd3d78e80920">StimPlugin::notifySpikeGLAboutStart</a>()
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     <a class="code" href="../../d5/d21/structStimApp_1_1LeoDAQGLNotifyParams.html" title="Some parameters related to the external LeoDAQGL program notification.">StimApp::LeoDAQGLNotifyParams</a> &amp; p(<a class="code" href="../../d2/daf/namespaceUtil.html#c0a2da61553e34ad735a51325f29ae37" title="Returns a pointer to the StimApp singleton instance.">stimApp</a>()-&gt;leoDAQGLNotifyParams);
<a name="l00253"></a>00253     
<a name="l00254"></a>00254     <a class="code" href="../../da/dbe/namespaceStimGL__LeoDAQGL__Integration.html#0e5218165353220cb6db1905724302c1">StimGL_LeoDAQGL_Integration::Notify_PluginStart</a>(<a class="code" href="../../d0/d7e/classStimPlugin.html#c855a6f3fd359456f0db60ca01c72517" title="just calls QObject::objectName()">name</a>(), <a class="code" href="../../d0/d7e/classStimPlugin.html#cb74ac120b53158c07e8f7f6877f2bb4" title="We return an implicitly shared copy of the parameters. Due to multithreading concerns...">getParams</a>(),
<a name="l00255"></a>00255                                                     0,
<a name="l00256"></a>00256                                                     p.<a class="code" href="../../d5/d21/structStimApp_1_1LeoDAQGLNotifyParams.html#e19829767715eb7d0fd67d94faf01335">hostname</a>,
<a name="l00257"></a>00257                                                     p.<a class="code" href="../../d5/d21/structStimApp_1_1LeoDAQGLNotifyParams.html#88154f664660cd56549f8ac405982540">port</a>,
<a name="l00258"></a>00258                                                     p.<a class="code" href="../../d5/d21/structStimApp_1_1LeoDAQGLNotifyParams.html#f904e08bb76abdd6b14071ecb758ba7e">timeout_ms</a>);
<a name="l00259"></a>00259     <a class="code" href="../../d0/d7e/classStimPlugin.html#2cbec86f764f0fa56acc1fa6e22193fc" title="iff true, we will notify LeoDAQGL of plugin start on unpause">needNotifyStart</a> = <span class="keyword">false</span>;
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a><a class="code" href="../../d0/d7e/classStimPlugin.html#d1af564d84dd406844fdb960f4401d81">00262</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7e/classStimPlugin.html#d1af564d84dd406844fdb960f4401d81">StimPlugin::notifySpikeGLAboutStop</a>()
<a name="l00263"></a>00263 {
<a name="l00264"></a>00264         <a class="code" href="../../d5/d21/structStimApp_1_1LeoDAQGLNotifyParams.html" title="Some parameters related to the external LeoDAQGL program notification.">StimApp::LeoDAQGLNotifyParams</a> &amp; p(<a class="code" href="../../d2/daf/namespaceUtil.html#c0a2da61553e34ad735a51325f29ae37" title="Returns a pointer to the StimApp singleton instance.">stimApp</a>()-&gt;leoDAQGLNotifyParams);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         <a class="code" href="../../da/dbe/namespaceStimGL__LeoDAQGL__Integration.html#65535111fc94579b3b5f5f6e81126852">StimGL_LeoDAQGL_Integration::Notify_PluginEnd</a>(<a class="code" href="../../d0/d7e/classStimPlugin.html#c855a6f3fd359456f0db60ca01c72517" title="just calls QObject::objectName()">name</a>(), <a class="code" href="../../d0/d7e/classStimPlugin.html#cb74ac120b53158c07e8f7f6877f2bb4" title="We return an implicitly shared copy of the parameters. Due to multithreading concerns...">getParams</a>(),
<a name="l00267"></a>00267                                                         0,
<a name="l00268"></a>00268                                                         p.<a class="code" href="../../d5/d21/structStimApp_1_1LeoDAQGLNotifyParams.html#e19829767715eb7d0fd67d94faf01335">hostname</a>,
<a name="l00269"></a>00269                                                         p.<a class="code" href="../../d5/d21/structStimApp_1_1LeoDAQGLNotifyParams.html#88154f664660cd56549f8ac405982540">port</a>,
<a name="l00270"></a>00270                                                         p.<a class="code" href="../../d5/d21/structStimApp_1_1LeoDAQGLNotifyParams.html#f904e08bb76abdd6b14071ecb758ba7e">timeout_ms</a>);
<a name="l00271"></a>00271         <a class="code" href="../../d0/d7e/classStimPlugin.html#2cbec86f764f0fa56acc1fa6e22193fc" title="iff true, we will notify LeoDAQGL of plugin start on unpause">needNotifyStart</a> = <span class="keyword">true</span>;
<a name="l00272"></a>00272 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Sun Jun 21 17:53:57 2009 for StimulateOpenGL_II by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.4 </small></address>
</body>
</html>
